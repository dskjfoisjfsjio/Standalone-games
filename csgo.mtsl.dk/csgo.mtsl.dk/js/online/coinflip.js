import{goToPreviousPage as e,numToValuta as t,showPage as n,user as o}from"/script.js?v=2.19";import{getItem as i,giveItem as c,removeItemsFromInventory as s,renderItem as r,selectItems as a}from"/js/items.js?v=2.19";import{convl as l,convr as f}from"/js/itemsn.js?v=2.19";import{getProfile as u}from"/js/online/profile.js?v=2.19";import{game as m}from"/js/game.js?v=2.19";import{createNotification as p}from"/js/notifications.js?v=2.19";import{displayWinnings as g}from"/js/winnings.js?v=2.19";import{Pages as h}from"/js/pages.js?v=2.19";const d=h.createPage("coinflip-online");const y=h.createPage("coinflip-online-game");const b=h.createPage("coinflip-online-select");function w(){return new Promise((e=>{b.innerHTML="";b.q("h1","You pick!");b.q("p","You select what coin you want!");b.q("p","Note: If nobody joins your game in 24 hours, it will expire, and you will be returned your items.");b.q(".cf-pick-coins",[q(".cf-coin-s.cf-coin-s-ct",{onclick(){e(0)}}),q(".cf-coin-s.cf-coin-s-t",{onclick(){e(1)}})]);n("coinflip-online-select",true)}))}let v=0;function x(){o.online??={};o.online.coinflipGames??={};d.innerHTML="Loading games...";fetch("https://csgo.mtsl.dk/api/v16/coinflip.asp?mode=get-games&lu="+localStorage.localuser).then((e=>e.json())).then((e=>{if(e.error==="too-many-requests"){setTimeout((()=>{x()}),500);return false}d.innerHTML="";v++;d.q("button.button.back-btn",{text:"Back",onclick(){n("betting")}});d.q("h1","Coinflip Online").q(".h1-beta-flag","Beta");d.q(".cf-about",{html:"In Coinflip Online, you can either join a game and roughly match their bet, or create your own game.<br>If you win a coinflip game, you have 2 days to collect your winnings.<br>The odds are in favour of who bets the most, but should always be around ~50%."});const i=d.q(".coinflip-controls");const c=i.q("button.button",{text:"Create Game",onclick(){a(500,undefined,25).then((e=>{let t=0;let n=[];e.forEach((e=>{n.push(f[e.name]);t+=e.price}));n=n.join(",");w().then((o=>{fetch("https://csgo.mtsl.dk/api/v16/coinflip.asp?mode=create-game&lu="+localStorage.localuser+"&n="+encodeURIComponent(u().name)+"&ba="+t+"&bi="+n+"&c="+o).then((e=>e.json())).then((t=>{if(t.success){s(e.map((e=>e.name)));j(t.gameid,n);k(t.gameid)}else{console.warn(t);alert(t.description)}}))}))}))}});i.q("button.button",{text:"Refresh",onclick(){x()}});const r=d.q(".cf-game-section");r.q(".cf-game-section-header","Your Games");let l=r.q(".cf-game-section-empty","You don't have any coinflip games");const m=d.q(".cf-game-section");m.q(".cf-game-section-header","Open Games");let p=m.q(".cf-game-section-empty",'There are no public coinflip games, create a new one with "Create Game"');let g=0;e.sort(((e,t)=>e.expireIn-t.expireIn)).forEach((e=>{try{if(e.creator)decodeURIComponent(e.creator);if(e.guest)decodeURIComponent(e.guest)}catch(t){console.log(t,e);return}if(parseInt(e.gameid)>g)g=parseInt(e.gameid);if(e.state==="FINI"&&!o.online.coinflipGames[e.gameid])return;if(e.expireIn-20<0&&!o.online.coinflipGames[e.gameid])return;const n=(new Date).getTime()/1e3;const i=q(".cf-game");if(e.you==="creator"&&e.state==="WAIT")c.disabled=true;if(e.you!=="nobody"){r.appendChild(i);if(l)r.removeChild(l);l=false}else if(e.state==="WAIT"){m.appendChild(i);if(p)m.removeChild(p);p=false}else return;const s=i.q(".cf-game-info",[q(".cf-g-col.cf-g-player",{classes:[e.winner!=="0"&&(e.winner==="1"?"cf-g-h-winner":"cf-g-h-loser"),e.you==="creator"&&"cf-g-h-you"],children:[q(".cf-g-player-s",{text:e.winner!=="0"?e.winner==="1"?"Winner":"Loser":""}),q(".cf-g-player-p",{text:!e.creator?"?":e.you==="creator"?"You":decodeURIComponent(e.creator)}),q(".cf-g-coin.cf-g-coin-c",{classes:[e.choice==="CT"?"cf-g-coin-ct":"cf-g-coin-t"]}),q(".cf-g-player-p-a",{text:t(e.creator_bet,2)})]}),q(".cf-g-col.cf-g-vs",{text:"vs."}),q(".cf-g-col.cf-g-player",{classes:[e.winner!=="0"&&(e.winner==="2"?"cf-g-h-winner":"cf-g-h-loser"),!e.guest&&"cf-g-joinable",e.you==="guest"&&"cf-g-h-you"],children:[q(".cf-g-player-s",{text:e.winner!=="0"?e.winner==="2"?"Winner":"Loser":""}),q(".cf-g-player-p",{text:!e.guest?"?":e.you==="guest"?"You":decodeURIComponent(e.guest)}),q(".cf-g-coin.cf-g-coin-c",{classes:[e.choice!=="CT"?"cf-g-coin-ct":"cf-g-coin-t"]}),q(".cf-g-player-p-a",{text:e.guest_bet?t(e.guest_bet,2):""})]})]);const a=i.q({style:{display:"flex",justifyContent:"center"}});a.q(".cf-game-btns").q("button.button",{text:e.winner!=="0"&&e.winner===I[e.you]?"Collect Your Winnings":"See",onclick(){k(e.gameid)}});if(e.state==="FINI"&&e.winner!==I[e.you]){const t=a.q(".cf-game-btns").q("button.button",{text:"Dismiss this game",onclick(){G(e.gameid)}});let o=v;const i=setInterval((()=>{t.innerText="Dismissing in "+Y(Math.floor(e.expireIn-((new Date).getTime()/1e3-n)));if(v!==o)clearInterval(i)}),1e3)}if(!e.guest)i.q(".cf-g-joinable-text",{text:"Looking for contestant"});setTimeout((()=>{if(i.parentElement)i.parentElement.removeChild(i)}),(e.expireIn-(e.you==="creator"||o.online.coinflipGames[e.gameid]?1:120))*1e3)}));if(g>0)d.q(".cf-games-total",{text:g+" coinflips games have been created!"})}));C()}function C(){o.online??={};o.online.coinflipGames??={};for(let e=0;e<Object.keys(o.online.coinflipGames).length;e++){let t=Object.keys(o.online.coinflipGames)[e];fetch("https://csgo.mtsl.dk/api/v16/coinflip.asp?mode=get-game&gameid="+t+"&lu="+localStorage.localuser).then((e=>e.json())).then((e=>{if(!e.success&&e.error==="game-not-found")M(t);else if(e.state==="FINI"&&e.you==="creator"&&!o.online.coinflipGames[t].msg){o.online.coinflipGames[t].msg=true;o.online.coinflipGames[t].lost=e.winner!==I[e.you];p({message:"A coinflip game has been finished. <a>Click here to see if you have won!</a>",useHTML:true,onclick(){k(t)}})}}))}}setTimeout((()=>{C()}),1e4);setInterval((()=>{C()}),12e4);let T=0;function k(o,c,m){T++;n("coinflip-online-game",c,true);if(!m)y.innerHTML="Loading game...";fetch("https://csgo.mtsl.dk/api/v16/coinflip.asp?mode=get-game&gameid="+o+"&lu="+localStorage.localuser).then((e=>e.json())).then((n=>{let c=T;if(!n.success){y.innerHTML="";y.q(".cf-gi-title",{text:"Coinflip Game Removed | Not found"});y.q({text:"This game doesn't exist anymore. Either because it has expired, or 2 days have gone since it was finished.",style:{textAlign:"center"}});y.q("button.button.back-btn",{text:"Go back",onclick(){e()}});return}setTimeout((()=>{if(c===T&&n.state==="WAIT"){m=n.state;k(o,true,n.state)}}),1e4);if(m&&n.state===m){m=false;return}y.innerHTML="";y.q(".cf-gi-title",{text:decodeURIComponent(n.creator)+" vs. "+(decodeURIComponent(n.guest)||"?")});y.q("button.button.back-btn",{text:"Back",onclick(){e()}});const p=y.q(".cf-coin-area.hide");const g=y.q(".center");const h=y.q(".cf-gi-players");const d=h.q(".cf-gi-player");d.q(".center").q("img",{src:"/images/coin_"+n.choice.toLowerCase()+".png",height:32});let b=0,q=0;const w=d.q(".cf-gi-player-bet");const v=d.q(".cf-gi-player-inventory.compact");n.creator_items.split(",").splice(0,25).forEach((e=>{if(e==="")return;e=i(l[e]);b+=e.price;v.appendChild(r(e))}));w.innerText=(n.you==="creator"?"Your":decodeURIComponent(n.creator)+"'s")+" bet: "+t(b,2);let x=false;if(n.creator_bet*1.01<b||n.creator_bet*.99>b)x=true;const C=h.q(".cf-gi-player");C.q(".center").q("img.cf-img",{src:"/images/coin_"+(n.choice==="CT"?"T":"CT").toLowerCase()+".png",height:32});let M=C.q(".cf-gi-player-bet","Join!");const Y=C.q(".cf-gi-player-inventory.compact");if(n.guest_items){n.guest_items.split(",").splice(0,25).forEach((e=>{if(e==="")return;e=i(l[e]);q+=e.price;Y.appendChild(r(e))}));M.innerText=(n.you==="guest"?"Your":decodeURIComponent(n.guest)+"'s")+" bet: "+t(q,2)}else{Y.q("button.button",{text:x?"Due to skin price differences, this game is unavailable for you.":"Join this coinflip!",disabled:x||n.you!=="nobody",onclick(){if(n.you!=="nobody")return;a(n.creator_bet*.9,n.creator_bet*1.1,25).then((e=>{let t=0;let n=[];e.forEach((e=>{n.push(f[e.name]);t+=e.price}));n=n.join(",");fetch("https://csgo.mtsl.dk/api/v16/coinflip.asp?mode=join-game&gameid="+o+"&lu="+localStorage.localuser+"&n="+encodeURIComponent(u().name)+"&bi="+n+"&ba="+t).then((e=>e.json())).then((t=>{if(t.success){s(e.map((e=>e.name)));j(o,n);k(o,true)}else{console.warn(t);alert(t.description)}}))}))}})}if(n.winner==="0"){}else if(n.you==="nobody"){let e=n.choice==="CT"?0:1;if(n.winner==="2")e=e===0?1:0;p.classList.remove("hide");const t=p.q(".coinflip-perspective").q("#coinflip-coin");t.q(".coinflip-face-ct");t.q(".coinflip-face-t");setTimeout((()=>{if(T!==c)return;t.style.transition="4s";t.style.transform=`rotateY(${180*Math.ceil(8+e)}deg)`}),100)}else if(n.winner===I[n.you]){let e=n.choice==="CT"?0:1;if(n.you==="guest")e=e===0?1:0;p.classList.remove("hide");const t=p.q(".coinflip-perspective").q("#coinflip-coin");t.q(".coinflip-face-ct");t.q(".coinflip-face-t");setTimeout((()=>{if(T!==c)return;t.style.transition="4s";t.style.transform=`rotateY(${180*Math.ceil(8+e)}deg)`}),100);setTimeout((()=>{if(T!==c)return;g.q(".cf-gi-ws","You won!");g.q("button.button",{text:"Collect your winnings",onclick(){L(n.gameid,n.creator_items,n.guest_items,n.creator_bet,n.guest_bet)}})}),4100)}else{let e=n.choice==="CT"?1:0;if(n.you==="guest")e=e===0?1:0;p.classList.remove("hide");const t=p.q(".coinflip-perspective").q("#coinflip-coin");t.q(".coinflip-face-ct");t.q(".coinflip-face-t");setTimeout((()=>{if(T!==c)return;t.style.transition="4s";t.style.transform=`rotateY(${180*Math.ceil(8+e)}deg)`}),100);setTimeout((()=>{if(T!==c)return;g.q(".cf-gi-ws","You lost...");g.q("button.button",{text:"Dismiss the game",onclick(){G(n.gameid)}})}),4100)}}))}m.on("showPage",(e=>e.page==="coinflip-online"&&x()));let I={nobody:"0",creator:"1",guest:"2"};function j(e,t){o.online.coinflipGames[e]={g:true,i:t}}function G(e){delete o.online.coinflipGames[e];n("coinflip-online")}function L(e,t,n,s,r){if(!o.online.coinflipGames[e])return;delete o.online.coinflipGames[e];let a=[];let f=0,u=0;t.split(",").map((e=>l[e])).forEach((e=>{f+=i(e).price;if(f>s*1.01)return;a.push(i(e));c(e)}));n.split(",").map((e=>l[e])).forEach((e=>{u+=i(e).price;if(u>r*1.01)return;a.push(i(e));c(e)}));g({title:"Your winnings!",returnBtn:{text:"Go back!",page:"coinflip-online"},items:a,sortBy:"value"})}m.on("showPage",(e=>{if(e!=="coinflip-online-game")T++}));function M(e){if(!o.online.coinflipGames[e].i||o.online.coinflipGames[e].lost){delete o.online.coinflipGames[e];return}o.online.coinflipGames[e].i.split(",").map((e=>l[e])).forEach((e=>{c(e)}));delete o.online.coinflipGames[e];p({message:"Your coinflip game timeouted, your items have been returned."})}function Y(e){if(e<60)return e+" second"+(e===1?"":"s");if(e<60*60)return Math.floor(e/60)+" minute"+(Math.floor(e/60)===1?"":"s");if(e<60*60*24)return Math.floor(e/60/60)+" hour"+(Math.floor(e/60/60)===1?"":"s");else return Math.floor(e/60/60/24)+" day"+(Math.floor(e/60/60/24)===1?"":"s")}